# =============================================================================
# analysis_config.yaml — Single source of truth for all inference configs
# =============================================================================
#
# DB     : glue-dispenser-db (TimescaleDB)
# Table  : process_metrics
# Format : long → (timestamp, station_name, metric_name, value, unit, state_context)
#          DataLoader pivots long→wide (one row per cycle) before model pipelines
#
# Metric naming: <station>/<metric>
# target_column : the wide-format column name that is the prediction target
#
# analysis_types: forecast | anomaly | health_score | rul
# forecast_method: mamba
# anomaly_method:  zscore | western_electric | isolation_forest
# =============================================================================

global:
  db:
    database_url_env: DATABASE_URL
    input_table: process_metrics
    output_table: analysis_results
    schema: public
  mlflow:
    tracking_uri_env: MLFLOW_TRACKING_URI
    artifact_root_env: MLFLOW_ARTIFACT_ROOT

# ---------------------------------------------------------------------------
# Per-metric configs. Unset fields inherit from global.
# ---------------------------------------------------------------------------
target:

  # ── SYSTEM ────────────────────────────────────────────────────────────────

  system__cycle_time:
    - method: mamba
      required_features:
        - system__cycle_time
        - shuttle_scan_success_time
        - shuttle_carrier_motion_time
        - l1_dispenser__dispenser_dispensing_time
        - l1_inspection__inspection_core_vision_system_time
        - timestamp

      history_window: 6
      stride: 2
      prediction_window: 4

      mode: offline

      arch:
        seq_len: 12
        hidden_dim: 64
        d_state: 16
        d_conv: 4
        num_layers: 2
        loss_weight_recon: 0.3
        device: auto 

      train_params:
        num_epochs: 200
        learning_rate: 0.001
        dropout: 0.2

      analysis_types: [forecast]


  #   metric: cycle_time
  #   target_column: system__cycle_time
  #   anomaly:
  #     method: western_electric
  #     we_rules: [1, 2, 3, 4]
  #   health_rul:
  #     failure_threshold_multiplier: 1.3

  # - station: system
  #   metric: total_time
  #   target_column: system__total_time
  #   analysis_types: [forecast, anomaly]
  #   required_features:
  #     - system__total_time
  #     - system__cycle_time
  #     - shuttle_scan_success_time
  #   anomaly:
  #     method: zscore
  #     zscore_threshold: 3.0

  # - station: system
  #   metric: rolling_uph
  #   target_column: system__rolling_uph
  #   analysis_types: [forecast, health_score]
  #   required_features:
  #     - system__rolling_uph
  #     - system__cycle_time
  #     - system__yield
  #   mamba:
  #     seq_len: 10
  #     hidden_dim: 64
  #     d_state: 8

  # - station: system
  #   metric: yield
  #   target_column: system__yield
  #   analysis_types: [forecast, anomaly, health_score]
  #   required_features:
  #     - system__yield
  #     - system__ng_pallets
  #     - system__total_pallets
  #     - l1_inspection__inspection_core_vision_system_time
  #     - l2_inspection__inspection_core_vision_system_time
  #   anomaly:
  #     method: western_electric
  #     we_rules: [1, 2]

  # # ── SHUTTLE STATION ────────────────────────────────────────────────────────

  # - station: shuttle_station
  #   metric: shuttle_scan_success_time
  #   target_column: shuttle_scan_success_time
  #   analysis_types: [forecast, anomaly, health_score, rul]
  #   required_features:
  #     - shuttle_scan_success_time
  #     - shuttle_pre_scan_time
  #     - shuttle_post_scan_delay
  #     - system__count
  #   anomaly:
  #     method: isolation_forest
  #     if_contamination: 0.05
  #   health_rul:
  #     failure_threshold_multiplier: 2.0

  # - station: shuttle_station
  #   metric: shuttle_carrier_motion_time
  #   target_column: shuttle_carrier_motion_time
  #   analysis_types: [forecast, anomaly, rul]
  #   required_features:
  #     - shuttle_carrier_motion_time
  #     - shuttle_stopper_lowering_time
  #     - shuttle_pallet_release_time
  #     - shuttle_stopper_rising_time
  #   anomaly:
  #     method: zscore
  #     zscore_threshold: 2.5

  # - station: shuttle_station
  #   metric: shuttle_pre_scan_time
  #   target_column: shuttle_pre_scan_time
  #   analysis_types: [anomaly]
  #   required_features:
  #     - shuttle_pre_scan_time
  #     - shuttle_scan_success_time
  #   anomaly:
  #     method: zscore
  #     zscore_threshold: 2.5
  #     zscore_window: 30

  # # ── L1 DISPENSER ──────────────────────────────────────────────────────────

  # - station: l1_dispenser
  #   metric: dispensing_time
  #   target_column: l1_dispenser__dispenser_dispensing_time
  #   analysis_types: [forecast, anomaly, health_score, rul]
  #   required_features:
  #     - l1_dispenser__dispenser_dispensing_time
  #     - l1_dispenser__dispenser_gantry_positioning_time
  #     - l1_dispenser__dispenser_pallet_lifting_1_time
  #     - l1_dispenser__dispenser_entry_clamping_time
  #     - system__cycle_time
  #   anomaly:
  #     method: western_electric
  #     we_rules: [1, 2, 3, 4]
  #   health_rul:
  #     failure_threshold_multiplier: 1.8

  # - station: l1_dispenser
  #   metric: gantry_positioning_time
  #   target_column: l1_dispenser__dispenser_gantry_positioning_time
  #   analysis_types: [forecast, anomaly, rul]
  #   required_features:
  #     - l1_dispenser__dispenser_gantry_positioning_time
  #     - l1_dispenser__dispenser_delay_pre_gantry_positioning
  #     - l1_dispenser__dispenser_dispensing_time
  #   anomaly:
  #     method: zscore
  #     zscore_threshold: 3.0

  # # ── L1 INSPECTION ─────────────────────────────────────────────────────────

  # - station: l1_inspection
  #   metric: core_vision_system_time
  #   target_column: l1_inspection__inspection_core_vision_system_time
  #   analysis_types: [forecast, anomaly, health_score, rul]
  #   required_features:
  #     - l1_inspection__inspection_core_vision_system_time
  #     - l1_inspection__inspection_gantry_positioning_time
  #     - l1_inspection__inspection_lifter_rising_time
  #     - l1_inspection__inspection_post_vision_check_delay
  #     - system__yield
  #   anomaly:
  #     method: isolation_forest
  #     if_contamination: 0.05
  #   health_rul:
  #     failure_threshold_multiplier: 2.0

  # # ── L2 DISPENSER ──────────────────────────────────────────────────────────

  # - station: l2_dispenser
  #   metric: dispensing_time
  #   target_column: l2_dispenser__dispenser_dispensing_time
  #   analysis_types: [forecast, anomaly, health_score, rul]
  #   required_features:
  #     - l2_dispenser__dispenser_dispensing_time
  #     - l2_dispenser__dispenser_gantry_positioning_time
  #     - l2_dispenser__dispenser_pallet_lifting_1_time
  #     - l2_dispenser__dispenser_entry_clamping_time
  #     - system__cycle_time
  #   anomaly:
  #     method: western_electric
  #     we_rules: [1, 2, 3, 4]
  #   health_rul:
  #     failure_threshold_multiplier: 1.8

  # # ── L2 INSPECTION ─────────────────────────────────────────────────────────

  # - station: l2_inspection
  #   metric: core_vision_system_time
  #   target_column: l2_inspection__inspection_core_vision_system_time
  #   analysis_types: [forecast, anomaly, health_score, rul]
  #   required_features:
  #     - l2_inspection__inspection_core_vision_system_time
  #     - l2_inspection__inspection_gantry_positioning_time
  #     - l2_inspection__inspection_lifter_rising_time
  #     - l2_inspection__inspection_post_vision_check_delay
  #     - system__yield
  #   anomaly:
  #     method: isolation_forest
  #     if_contamination: 0.05
  #   health_rul:
  #     failure_threshold_multiplier: 2.0

  # # ── L1 BUFFER ─────────────────────────────────────────────────────────────

  # - station: l1_buffer_a
  #   metric: buffer_holding_time
  #   target_column: l1_buffer_a__buffer_holding_time
  #   analysis_types: [anomaly, health_score]
  #   required_features:
  #     - l1_buffer_a__buffer_holding_time
  #     - l1_buffer_a__buffer_stopper_lowering_time
  #     - l1_buffer_a__buffer_pallet_release_time
  #   anomaly:
  #     method: zscore
  #     zscore_threshold: 3.0
