version: "2.0"
description: "Updated Stage 1 Logic: System Metrics and Granular Shuttle Control"

patterns:
  # ==========================================
  # 1. SYSTEM WIDE
  # ==========================================
  - name: "Application Initialized"
    regex: "Application initialized\\s*$"
    event_type: "SYSTEM_RESET"
    target_id: "system"

  - name: "Pallet Cycle Count"
    regex: "Pallet detected\\. Count = (?P<count>\\d+)"
    event_type: "CYCLE_COUNT"
    target_id: "system"

  - name: "Global Cycle Time"
    regex: "CycleTime for pallet (?P<pallet_id>\\S+): (?P<cycle_time>[0-9]+(?:\\.[0-9]+)?) sec"
    event_type: "CYCLE_TIME"
    target_id: "system"

  - name: "Global Metrics Update"
    regex: "Updated metrics => TotalPallets:\\s*(?P<TotalPallets>\\d+),\\s*TotalUnits:\\s*(?P<TotalUnits>\\d+),\\s*OK:\\s*(?P<OK>\\d+),\\s*NG:\\s*(?P<NG>\\d+),\\s*Yield:\\s*(?P<Yield>[\\d.]+)%,\\s*Rolling UPH:\\s*(?P<Rolling_UPH>\\d+),\\s*TotalTime:\\s*(?P<TotalTime>[\\d.]+)"
    event_type: "UPDATED_METRICS"
    target_id: "system"

  # ==========================================
  # 2. SHUTTLE STATION
  # ==========================================
  - name: "Shuttle Pallet Arrival"
    regex: "Pallet state rising edge detected for ShuttlePalletPresenceSensorDI"
    event_type: "PALLET_ARRIVAL"
    target_id: "shuttle_station"
    category: "arrival"

  - name: "Barcode Position Reach"
    regex: "Pallet is at Barcode"
    event_type: "AT_BARCODE"
    target_id: "shuttle_station"

  - name: "Barcode Scan Success"
    regex: "Barcode (?P<pallet_id>\\S+) detected from pallet"
    event_type: "SCAN_SUCCESS"
    target_id: "shuttle_station"

  - name: "Barcode Scan Attempt Fail"
    regex: "Attempt \\d+: Failed to read barcode for pallet \\.$"
    event_type: "SCAN_ATTEMPT_FAIL"
    target_id: "shuttle_station"

  - name: "Barcode Scan Final Failure"
    regex: "Failed to read barcode for pallet  after \\d+ attempts. Taking alternative action."
    event_type: "SCAN_FAILURE"
    target_id: "shuttle_station"

  - name: "Carrier Motion Start"
    regex: "Axis 8: MoveAbs started â†’ -?\\d+"
    event_type: "CARRIER_STARTED"
    target_id: "shuttle_station"
    category: "handover_prep"

  - name: "Stopper Lowering Trigger"
    regex: "Shuttle Stopper Down: DOWN command issued"
    event_type: "STOPPER_DOWN_START"
    target_id: "shuttle_station"

  - name: "Stopper Lowered Confirmed"
    regex: "Shuttle Stopper Down: DOWN confirmed"
    event_type: "STOPPER_DOWN_DONE"
    target_id: "shuttle_station"

  - name: "Stopper Raising Trigger"
    regex: "Shuttle Stopper Up: UP command issued"
    event_type: "STOPPER_UP_START"
    target_id: "shuttle_station"

  - name: "Stopper Raised Confirmed"
    regex: "Shuttle Stopper Up: UP confirmed"
    event_type: "STOPPER_UP_DONE"
    target_id: "shuttle_station"
    category: "handover"

  # ==========================================
  # 3. BUFFER STATIONS
  # Logic States: EMPTY -> HOLDING -> RELEASING
  # ==========================================

  # Transition: EMPTY -> HOLDING
  - name: "Buffer Pallet Arrival"
    regex: null # Sensor driven "L1BufferAPalletPresenceSensorDI"
    event_type: "PALLET_ARRIVAL"
    # Note: Value mapping happens in code if this is generic, or specific regex per buffer

  # Transition: HOLDING -> RELEASING
  - name: "Buffer Stopper Open"
    # Matches: "L1 Buffer A Release"
    regex: "(?P<station_name>[\\w\\s]+) Release" 
    event_type: "STOPPER_OPEN"
    value_mapping:
      station_name:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: RELEASING -> EMPTY
  - name: "Buffer Pallet Departure"
    regex: null # Sensor driven (Falling Edge of Presence)
    event_type: "PALLET_LEFT_SENSOR"

