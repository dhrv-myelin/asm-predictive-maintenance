version: "2.0"
description: "Updated Stage 1 Logic: System Metrics and Granular Shuttle Control"

patterns:
  # ==========================================
  # 1. SYSTEM WIDE
  # ==========================================
  - name: "Application Initialized"
    regex: "Application initialized\\s*$"
    event_type: "SYSTEM_RESET"
    target_id: "system"

  - name: "Pallet Cycle Count"
    regex: "Pallet detected\\. Count = (?P<count>\\d+)"
    event_type: "CYCLE_COUNT"
    target_id: "system"

  - name: "Global Cycle Time"
    regex: "CycleTime for pallet (?P<pallet_id>\\S+): (?P<cycle_time>[0-9]+(?:\\.[0-9]+)?) sec"
    event_type: "CYCLE_TIME"
    target_id: "system"

  - name: "Global Metrics Update"
    regex: "Updated metrics => TotalPallets:\\s*(?P<TotalPallets>\\d+),\\s*TotalUnits:\\s*(?P<TotalUnits>\\d+),\\s*OK:\\s*(?P<OK>\\d+),\\s*NG:\\s*(?P<NG>\\d+),\\s*Yield:\\s*(?P<Yield>[\\d.]+)%,\\s*Rolling UPH:\\s*(?P<Rolling_UPH>\\d+),\\s*TotalTime:\\s*(?P<TotalTime>[\\d.]+)"
    event_type: "UPDATED_METRICS"
    target_id: "system"

  # ==========================================
  # 2. SHUTTLE STATION
  # ==========================================
  - name: "Shuttle Pallet Arrival"
    regex: "Pallet state rising edge detected for ShuttlePalletPresenceSensorDI"
    event_type: "PALLET_ARRIVAL"
    target_id: "shuttle_station"
    category: "arrival"

  - name: "Barcode Position Reach"
    regex: "Pallet is at Barcode"
    event_type: "AT_BARCODE"
    target_id: "shuttle_station"

  - name: "Barcode Scan Success"
    regex: "Barcode (?P<pallet_id>\\S+) detected from pallet"
    event_type: "SCAN_SUCCESS"
    target_id: "shuttle_station"

  - name: "Barcode Scan Attempt Fail"
    regex: "Attempt \\d+: Failed to read barcode for pallet \\.$"
    event_type: "SCAN_ATTEMPT_FAIL"
    target_id: "shuttle_station"

  - name: "Barcode Scan Final Failure"
    regex: "Failed to read barcode for pallet  after \\d+ attempts. Taking alternative action."
    event_type: "SCAN_FAILURE"
    target_id: "shuttle_station"

  - name: "Carrier Motion Start"
    regex: "Axis 8: MoveAbs started â†’ (?P<destination>-?\\d+)"
    event_type: "CARRIER_STARTED"
    target_id: "shuttle_station"
    value_mapping:
      destination:
        "-523064": "l1_buffer_a"
        "15936": "l2_buffer_a"
    category: "handover_prep"

  - name: "Stopper Lowering Trigger"
    regex: "Shuttle Stopper Down: DOWN command issued"
    event_type: "STOPPER_DOWN_START"
    target_id: "shuttle_station"

  - name: "Stopper Lowered Confirmed"
    regex: "Shuttle Stopper Down: DOWN confirmed"
    event_type: "STOPPER_DOWN_DONE"
    target_id: "shuttle_station"

  - name: "Stopper Raising Trigger"
    regex: "Shuttle Stopper Up: UP command issued"
    event_type: "STOPPER_UP_START"
    target_id: "shuttle_station"

  - name: "Stopper Raised Confirmed"
    regex: "Shuttle Stopper Up: UP confirmed"
    event_type: "STOPPER_UP_DONE"
    target_id: "shuttle_station"
    category: "handover"

  # ==========================================
  # 3. BUFFER STATIONS
  # Logic States: EMPTY -> HOLDING -> RELEASING
  # ==========================================

  # Transition: IDLE -> HOLDING
  - name: "Buffer Pallet Arrival"
    # Matches: "Pallet T{E04}O{250711P01-511P-25070004-0010}P{HE00EJ6DH000}Q{1}S{C9145}G{46abf091-cb08-475e-8422-60c9078d555f}L{} sent to L1ConveyorBufferA successfully."
    regex: "Pallet (?P<pallet_id>\\S+) sent to (?P<target>\\S+) successfully\\."
    event_type: "PALLET_ARRIVAL"
    value_mapping:
      target:
        "L1ConveyorBufferA": "l1_buffer_a"
        "L1ConveyorBufferB": "l1_buffer_b"
        "L2ConveyorBufferA": "l2_buffer_a"
        "L2ConveyorBufferB": "l2_buffer_b"

  # Transition: HOLDING -> PALLET_RELEASING (via STOPPER_KEEPING_DOWN)
  - name: "Buffer Stopper Keeping Down"
    # Matches: "L2 Buffer A stopper keeping down"
    regex: "(?P<target>L[12] Buffer [AB]) stopper keeping down"
    event_type: "STOPPER_KEEPING_DOWN"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: HOLDING -> STOPPER_LOWERING
  - name: "Buffer Stopper Down Start"
    # Matches: "L1 Buffer A stopper Down: DOWN command issued"
    regex: "(?P<target>L[12] Buffer [AB]) stopper Down: DOWN command issued"
    event_type: "STOPPER_DOWN_START"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: STOPPER_LOWERING -> PALLET_RELEASING
  - name: "Buffer Stopper Down Done"
    # Matches: "L1 Buffer A stopper Down: DOWN confirmed"
    regex: "(?P<target>L[12] Buffer [AB]) stopper Down: DOWN confirmed"
    event_type: "STOPPER_DOWN_DONE"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: PALLET_RELEASING -> IDLE (via STOPPER_KEEPING_UP)
  - name: "Buffer Stopper Keeping Up"
    # Matches: "L2 Buffer A stopper keeping up"
    regex: "(?P<target>L[12] Buffer [AB]) stopper keeping up"
    event_type: "STOPPER_KEEPING_UP"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: PALLET_RELEASING -> STOPPER_RAISING
  - name: "Buffer Stopper Up Start"
    # Matches: "L1 Buffer A stopper Up: UP command issued"
    regex: "(?P<target>L[12] Buffer [AB]) stopper Up: UP command issued"
    event_type: "STOPPER_UP_START"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"

  # Transition: STOPPER_RAISING -> IDLE
  - name: "Buffer Stopper Up Done"
    # Matches: "L1 Buffer A stopper Up: UP confirmed"
    regex: "(?P<target>L[12] Buffer [AB]) stopper Up: UP confirmed"
    event_type: "STOPPER_UP_DONE"
    value_mapping:
      target:
        "L1 Buffer A": "l1_buffer_a"
        "L1 Buffer B": "l1_buffer_b"
        "L2 Buffer A": "l2_buffer_a"
        "L2 Buffer B": "l2_buffer_b"