version: "1.0"
description: "Updated Shuttle Station Process Logic"

definitions:
  # ==========================================
  # 1. SHUTTLE STATION (High-Granularity Logic)
  # ==========================================
  shuttle_station:
    initial_state: "IDLE"
    states:
      IDLE:
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "PRE_SCANNING"

      PRE_SCANNING:
        metrics:
          - name: "shuttle_pre_scan_time"
            type: "duration_seconds"
            description: "Time spent in pre-scan state before barcode is reached"
            
        transitions:
          - event: "AT_BARCODE"
            next_state: "SCANNING"

      SCANNING:
        metrics:
          - name: "shuttle_scan_success_time"
            type: "duration_seconds"
            description: "Time taken to successfully scan a pallet"
            
        transitions:
          - event: "SCAN_SUCCESS"
            next_state: "POST_SCANNING"
          - event: "SCAN_ATTEMPT_FAIL"
            next_state: "SCANNING"
            action: "increment_retry_counter"
          - event: "SCAN_FAILURE"
            next_state: "POST_SCANNING"
            description: "Move to post-scan even on failure for manual handling"

      POST_SCANNING:
        metrics:
          - name: "shuttle_post_scan_delay"
            type: "duration_seconds"
            description: "Delay after scanning before carrier motion starts"
            
        transitions:
          - event: "CARRIER_STARTED"
            next_state: "CARRIER_MOTION"

      CARRIER_MOTION:
        metrics:
          - name: "shuttle_carrier_motion_time"
            type: "duration_seconds"
            description: "Time taken for carrier to move pallet to the available line"
            
        transitions:
          - event: "STOPPER_DOWN_START"
            next_state: "STOPPER_LOWERING"

      STOPPER_LOWERING:
        metrics:
          - name: "shuttle_stopper_lowering_time"
            type: "duration_seconds"
            description: "Time taken for stopper to lower"
            
        transitions:
          - event: "STOPPER_DOWN_DONE"
            next_state: "PALLET_RELEASING"

      PALLET_RELEASING:
        metrics:
          - name: "shuttle_pallet_release_time"
            type: "duration_seconds"
            description: "Time taken for stopper to release pallet"
            
        transitions:
          - event: "STOPPER_UP_START"
            next_state: "STOPPER_RAISING"

      STOPPER_RAISING:
        metrics:
          - name: "shuttle_stopper_rising_time"
            type: "duration_seconds"
            description: "Time taken for stopper to raise back up"
            
        transitions:
          - event: "STOPPER_UP_DONE"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_up: true

  # ==========================================
  # 2. BUFFER STANDARD
  # ==========================================
  buffer_standard:
    initial_state: "IDLE"
    states:
      IDLE:
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "HOLDING"
            state_inference:
              sensors.presence: true
              actuators.stopper_up: true

      HOLDING:
        metrics:
          - name: "buffer_wait_time"
            type: "duration_seconds"
            description: "Starvation metric: How long pallet waited for machine"
        transitions:
          - event: "STOPPER_DOWN_START"
            next_state: "STOPPER_LOWERING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false
          - event: "STOPPER_KEEPING_DOWN"
            next_state: "PALLET_RELEASING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false
      
      STOPPER_LOWERING:
        transitions:
          - event: "STOPPER_DOWN_DONE"
            next_state: "PALLET_RELEASING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false

      PALLET_RELEASING:
        transitions:
          - event: "STOPPER_UP_START"
            next_state: "STOPPER_RAISING"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true
          - event: "STOPPER_KEEPING_UP"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true

      STOPPER_RAISING:
        transitions:
          - event: "STOPPER_UP_DONE"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true              

  exit_sink:
    initial_state: "ACTIVE"
    states:
      ACTIVE:
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "ACTIVE"
            action: "destroy_pallet"