version: "1.0"
description: "Updated Shuttle Station Process Logic"

definitions:
  # ==========================================
  # 1. SHUTTLE STATION (High-Granularity Logic)
  # ==========================================
  shuttle_station:
    initial_state: "IDLE"
    states:
      IDLE:
        metrics:
          - name: "shuttle_idle_time"
            type: "duration_seconds"
            description: "Time spent in IDLE state"
            
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "PRE_SCANNING"

      PRE_SCANNING:
        metrics:
          - name: "shuttle_pre_scan_time"
            type: "duration_seconds"
            description: "Time spent in pre-scan state before barcode is reached"
            
        transitions:
          - event: "AT_BARCODE"
            next_state: "SCANNING"

      SCANNING:
        metrics:
          - name: "shuttle_scan_success_time"
            type: "duration_seconds"
            description: "Time taken to successfully scan a pallet"
            
        transitions:
          - event: "SCAN_SUCCESS"
            next_state: "POST_SCANNING"
          - event: "SCAN_ATTEMPT_FAIL"
            next_state: "SCANNING"
            action: "increment_retry_counter"
          - event: "SCAN_FAILURE"
            next_state: "POST_SCANNING"
            description: "Move to post-scan even on failure for manual handling"

      POST_SCANNING:
        metrics:
          - name: "shuttle_post_scan_delay"
            type: "duration_seconds"
            description: "Delay after scanning before carrier motion starts"
            
        transitions:
          - event: "CARRIER_STARTED"
            next_state: "CARRIER_MOTION"

      CARRIER_MOTION:
        metrics:
          - name: "shuttle_carrier_motion_time"
            type: "duration_seconds"
            description: "Time taken for carrier to move pallet to the available line"
            
        transitions:
          - event: "STOPPER_DOWN_START"
            next_state: "STOPPER_LOWERING"

      STOPPER_LOWERING:
        metrics:
          - name: "shuttle_stopper_lowering_time"
            type: "duration_seconds"
            description: "Time taken for stopper to lower"
            
        transitions:
          - event: "STOPPER_DOWN_DONE"
            next_state: "PALLET_RELEASING"

      PALLET_RELEASING:
        metrics:
          - name: "shuttle_pallet_release_time"
            type: "duration_seconds"
            description: "Time taken for stopper to release pallet"
            
        transitions:
          - event: "STOPPER_UP_START"
            next_state: "STOPPER_RAISING"

      STOPPER_RAISING:
        metrics:
          - name: "shuttle_stopper_rising_time"
            type: "duration_seconds"
            description: "Time taken for stopper to raise back up"
            
        transitions:
          - event: "STOPPER_UP_DONE"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_up: true

  # ==========================================
  # 2. BUFFER STANDARD
  # ==========================================
  buffer_standard:
    initial_state: "IDLE"
    states:
      IDLE:
        metrics:
          - name: "buffer_idle_time"
            type: "duration_seconds"
            description: "Time buffer is empty"
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "HOLDING"
            state_inference:
              sensors.presence: true
              actuators.stopper_up: true

      HOLDING:
        metrics:
          - name: "buffer_holding_time"
            type: "duration_seconds"
            description: "Time pallet spends holding in buffer"
        transitions:
          - event: "STOPPER_DOWN_START"
            next_state: "STOPPER_LOWERING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false
          - event: "STOPPER_KEEPING_DOWN"
            next_state: "PALLET_RELEASING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false
      
      STOPPER_LOWERING:
        metrics:
          - name: "buffer_stopper_lowering_time"
            type: "duration_seconds"
            description: "Time taken for stopper to lower"
        transitions:
          - event: "STOPPER_DOWN_DONE"
            next_state: "PALLET_RELEASING"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false

      PALLET_RELEASING:
        metrics:
          - name: "buffer_pallet_release_time"
            type: "duration_seconds"
            description: "Time taken to release pallet"
        transitions:
          - event: "STOPPER_UP_START"
            next_state: "STOPPER_RAISING"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true
          - event: "STOPPER_KEEPING_UP"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true

      STOPPER_RAISING:
        metrics:
          - name: "buffer_stopper_rising_time"
            type: "duration_seconds"
            description: "Time taken for stopper to rise back up"
        transitions:
          - event: "STOPPER_UP_DONE"
            next_state: "IDLE"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true              
  # ==========================================
  # 3. DISPENSER STANDARD
  # ==========================================
  dispenser_standard:
    initial_state: "IDLE"
    states:
      IDLE:
        metrics:
          - name: "machine_idle_time"
            type: "duration_seconds"
            description: "Efficiency metric: Time spent doing nothing"
        transitions:
          - event: "UNCLAMP_START"
            next_state: "ENTRY_UNCLAMPING"
            state_inference:
              sensors.presence: true

      ENTRY_UNCLAMPING:
        metrics:
          - name: "dispenser_entry_unclamp_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "UNCLAMP_DONE"
            next_state: "POST_ENTRY_UNCLAMP"
            state_inference:
              actuators.clamp_lock: true
              actuators.clamp_unlock: false

      POST_ENTRY_UNCLAMP:
        metrics:
          - name: "dispenser_delay_post_entry_unclamp"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_LIFTING_1_START"
            next_state: "PALLET_LIFTING_1"
      
      PALLET_LIFTING_1:
        metrics:
          - name: "dispenser_pallet_lifting_1_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "CLAMP_START"
            next_state: "ENTRY_CLAMPING"

      ENTRY_CLAMPING:
        metrics:
          - name: "dispenser_entry_clamping_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "CLAMP_DONE"
            next_state: "PALLET_STOPPER_PREP"

      PALLET_STOPPER_PREP:
        metrics:
          - name: "dispenser_delay_post_clamping"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_STOPPER_OUT_START"
            next_state: "PALLET_STOPPER_RELEASING"

      PALLET_STOPPER_RELEASING:
        metrics:
          - name: "dispenser_pallet_stopper_releasing_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_STOPPER_OUT_DONE"
            next_state: "GANTRY_PREP"

      GANTRY_PREP:
        metrics:
          - name: "dispenser_delay_pre_gantry_positioning"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "POSITIONING_START"
            next_state: "POSITIONING"    

      POSITIONING:
        metrics:
          - name: "dispenser_gantry_positioning_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "POSITIONING_END"
            next_state: "DISPENSING"

      DISPENSING:
        metrics:
          - name: "dispenser_dispensing_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_UNPOSITIONING_START"
            next_state: "PALLET_UNPOSITIONING"

      PALLET_UNPOSITIONING:
        metrics:
          - name: "dispenser_pallet_unpositioning_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_STOPPER_IN_START"
            next_state: "PALLET_STOPPER_LOCKING"

      PALLET_STOPPER_LOCKING:
        metrics:
          - name: "dispenser_pallet_stopper_locking_time"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_STOPPER_IN_DONE"
            next_state: "PRE_EXIT_UNCLAMPING"  

      PRE_EXIT_UNCLAMPING:
        metrics:
          - name: "dispenser_pre_exit_unclamping"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "UNCLAMP_START"
            next_state: "EXIT_UNCLAMPING"
            state_inference:
              actuators.clamp_lock: false
              actuators.clamp_unlock: true

      EXIT_UNCLAMPING:
        metrics:
          - name: "dispenser_exit_unclamping"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "UNCLAMP_DONE"
            next_state: "POST_EXIT_UNCLAMP"
            state_inference:
              actuators.stopper_down: true
              actuators.stopper_up: false

      POST_EXIT_UNCLAMP:
        metrics:
          - name: "dispenser_post_exit_unclamp"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "PALLET_LOWERING_1_START"
            next_state: "PALLET_LOWERING_1"
            state_inference:
              sensors.presence: false
              actuators.stopper_down: false
              actuators.stopper_up: true

      PALLET_LOWERING_1:
        metrics:
          - name: "dispenser_pallet_lowering_1"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "STOPPER_DOWN_START"
            next_state: "STOPPER_LOWERING" 

      STOPPER_LOWERING:
        metrics:
          - name: "dispenser_stopper_lowering"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "STOPPER_DOWN_DONE"
            next_state: "PALLET_RELEASING"   

      PALLET_RELEASING:
        metrics:
          - name: "dispenser_pallet_releasing"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "STOPPER_UP_START"
            next_state: "STOPPER_RAISING"

      STOPPER_RAISING:
        metrics:
          - name: "dispenser_stopper_rasing"
            type: "duration_seconds"
            export: true
        transitions:
          - event: "STOPPER_UP_DONE"
            next_state: "IDLE"  

  # ==========================================
  # 5. SINK
  # ==========================================

  exit_sink:
    initial_state: "ACTIVE"
    states:
      ACTIVE:
        transitions:
          - event: "PALLET_ARRIVAL"
            next_state: "ACTIVE"
            action: "destroy_pallet"